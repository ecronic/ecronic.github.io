<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Ecronic`s Blog</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="image/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/tomorrow.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/typed.js/1.1.1/typed.min.js'></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
    <div id="wrapper" class="main">
        <header>
    <div class="container">
        <span class="banner"><a href="/">Ecronic`s Blog</a></span>
        <span class="menu">Menu</span>
        <ul class="menu_list hide">
            
                <li><a href="/" >主页</a></li>
            
                <li><a href="/categories/技术" >海无涯</a></li>
            
                <li><a href="/categories/生活" >慢生活</a></li>
            
                <li><a href="/archives" >归档</a></li>
            
                <li><a href="/resume" >阅历</a></li>
            
                <li><a href="/about" >关于</a></li>
            
        </ul>
    </div>
</header>
        <div class="theme_block">
    <div class="container">
        <h2>
            
                <a href="http://localhost:4000">码字织文</a>
            
        </h2>
    </div>
</div>

    <div class="container container-body">
    <article>
        <h1 class='post-title'>
            <span>Libvirt API开发指南</span>
        </h1>
        <section class='post-content'>
            
                
            
            <p>LibVirt 是一套用于控制虚拟化的API，除了提供了一套无关具体虚拟化细节的API 之外，还提供了一个daemon（libvirtd) 和一个控制台工具（virsh）。本文演示了如何在LibVirt 中新加一个API，并且在libvirtd 和virsh 中使用新的API 完成新的功能。</p>
<h3 id="开发环境构建"><a href="#开发环境构建" class="headerlink" title="开发环境构建"></a>开发环境构建</h3><p>首先你需要有一套可以编译的LibVirt 源码，在本文的示例中我们使用了v2.5.0 版本的源码，你可以通过以下指令来得到它。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/libvirt/libvirt.git</span><br><span class="line"><span class="built_in">pushd</span> libvirt &amp;&amp; git checkout v2.5.0 &amp;&amp; <span class="built_in">popd</span></span><br></pre></td></tr></table></figure></p>
<p>LibVirt 的编译需要Gnulib 的源码，不过因为网络的原因在墙内其Git 仓库很难获取，所以这里使用GitHub 上的镜像仓库，并通过环境变量引入。你可以设置好这一切并编译一遍源码。在上面的指令执行成功后执行。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/coreutils/gnulib.git</span><br><span class="line"><span class="built_in">export</span> GNULIB_SRCDIR=$(readlink -f ./gnulib)</span><br><span class="line"><span class="built_in">cd</span> ./libvirt</span><br><span class="line">./autogen.sh</span><br><span class="line">make -j8</span><br><span class="line">make check -j8</span><br></pre></td></tr></table></figure></p>
<p>如果你的编译依赖完备的话，LibVirt 可以正确编译并通过测试。如果你没有得到预期的结果，请检查你的编译环境并安装缺失的软件包。<br>示例中我们添加的API 为virConnectGetMagicFileContent，功能为获取运行虚拟化的机器上某个文件内容的最多前32 个字节。</p>
<h3 id="添加公共API"><a href="#添加公共API" class="headerlink" title="添加公共API"></a>添加公共API</h3><p>首先要做的是为LibVirt 添加公共API，这个API 也是LibVirt 为用户展现的API。此后通过一连串调用，我们会在libvirtd 和virsh 中通过调用这个公共API 来完成新功能。这里需要修改的文件有如下几个。<br>include/libvirt/libvirt-<em>.h: 这里需要完成公共API 的声明，此后通过包含头文件include/libvirt/libvirt.h 可调用此API。<br>src/libvirt_public.syms: 这里需要将新API 导出为全局符号，这样公共API 得以允许被其他函数访问，如果你在步骤[1] 中定义了一个需要被其他函数访问的数据结构，同样你也需要将它导出为全局符号。<br>src/libvirt-</em>.c: 这里需要实现步骤[1] 中声明的API，一般来说这里只调用驱动提供的API 即可，具体功能需要在每个hypervisor 的驱动中单独实现。</p>
<h4 id="API-的注释"><a href="#API-的注释" class="headerlink" title="API 的注释"></a>API 的注释</h4><p>首先要说明的是，公共API 必须要有合乎规范的注释。在编译时，docs/apibuild.py 会检查宏和公共API 的注释是否符合要求，如果发现不合格的注释，将中断整个编译过程。注释在声明和定义处皆可。</p>
<p>对于一个宏，注释的格式如下。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * MACRO_NAME:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * macro's comment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MACRO_NAME (SOMETHING_HERE)</span></span><br></pre></td></tr></table></figure></p>
<p>对于一个API，注释的格式如下。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * apiName:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @arg: arg's comment</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * synopsis for this api.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns what.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ret_type</span><br><span class="line">apiName(arg_type arg) &#123; &#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：API 注释中的单词Returns 标明了这是返回值的注释，不能随意修改。<br>声明公共API<br>目录include/libvirt 下有众多以libvirt- 开头的头文件，公共API 分散在其中。因为新的API 返回在运行虚拟化的主机上某个文件的某段内容，所以我们在头文件include/libvirt/libvirt-host.h 声明这个API。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/include/libvirt/libvirt-host.h b/include/libvirt/libvirt-host.h</span><br><span class="line">index <span class="number">07b</span>5d1594.<span class="number">.72</span>db263d2 <span class="number">100644</span></span><br><span class="line">--- a/include/libvirt/libvirt-host.h</span><br><span class="line">+++ b/include/libvirt/libvirt-host.h</span><br><span class="line">@@ <span class="number">-686</span>,<span class="number">5</span> +<span class="number">686</span>,<span class="number">27</span> @@ <span class="function"><span class="keyword">int</span> <span class="title">virNodeAllocPages</span><span class="params">(virConnectPtr conn,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">int</span> cellCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line">+<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ * VIR_CONNECT_MAGIC_FILE_PATH:</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * This is the absolute path of file.</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> VIR_CONNECT_MAGIC_FILE_PATH (<span class="meta-string">"/var/run/libvirt/magic_file"</span>)</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ * VIR_CONNECT_MAGIC_FILE_FORBIDDEN_STR:</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * If file's content match this, qemu driver will refused to boot VM</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> VIR_CONNECT_MAGIC_FILE_FORBIDDEN_STR (<span class="meta-string">"0xabadcafe"</span>)</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ * VIR_CONNECT_MAGIC_FILE_CONTENT_LEN:</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * Max length of file.</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">define</span> VIR_CONNECT_MAGIC_FILE_CONTENT_LEN (32)</span></span><br><span class="line">+</span><br><span class="line">+<span class="function"><span class="keyword">char</span> *<span class="title">virConnectGetMagicFileContent</span><span class="params">(virConnectPtr conn)</span></span>;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __VIR_LIBVIRT_HOST_H__ */</span></span></span><br></pre></td></tr></table></figure></p>
<p>这个Patch 做的事情非常简单：定义了三个以后会用到的宏，并且声明了公共API。因为这个功能需要访问远程主机上的文件，所以公共API 需要一个参数virConnectPtr，通过这个指针我们可以调用具体的remote 或hypervisor 驱动（前者用于远程调用，后者是真正操纵虚拟化的驱动，例如QEMU 驱动）。</p>
<p>除了这个文件以外，还需要将公共API 在src/libvirt_public.syms 中导出。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/libvirt_public.syms b/src/libvirt_public.syms</span><br><span class="line">index e01604cad.<span class="number">.4</span>db27dc2b <span class="number">100644</span></span><br><span class="line">--- a/src/libvirt_public.syms</span><br><span class="line">+++ b/src/libvirt_public.syms</span><br><span class="line">@@ <span class="number">-746</span>,<span class="number">4</span> +<span class="number">746</span>,<span class="number">9</span> @@ LIBVIRT_2<span class="number">.2</span><span class="number">.0</span> &#123;</span><br><span class="line">         virConnectNodeDeviceEventDeregisterAny;</span><br><span class="line"> &#125; LIBVIRT_2<span class="number">.0</span><span class="number">.0</span>;</span><br><span class="line">+LIBVIRT_2<span class="number">.5</span><span class="number">.0</span> &#123;</span><br><span class="line">+    global:</span><br><span class="line">+        virConnectGetMagicFileContent;</span><br><span class="line">+&#125; LIBVIRT_2<span class="number">.2</span><span class="number">.0</span>;</span><br><span class="line">+</span><br><span class="line"> # .... define <span class="keyword">new</span> API here <span class="keyword">using</span> predicted next version number ....</span><br></pre></td></tr></table></figure></p>
<p>完成这一步工作之后，新的公共API 就可以被其他的函数所调用</p>
<h4 id="实现公共API"><a href="#实现公共API" class="headerlink" title="实现公共API"></a>实现公共API</h4><p>对应头文件include/libvirt/libvirt-host.h，我们需要在文件src/libvirt-host.c 中实现新API<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/libvirt-host.c b/src/libvirt-host.c</span><br><span class="line">index <span class="number">335798</span>abf.<span class="number">.0</span>b8b41ca9 <span class="number">100644</span></span><br><span class="line">--- a/src/libvirt-host.c</span><br><span class="line">+++ b/src/libvirt-host.c</span><br><span class="line">@@ <span class="number">-1482</span>,<span class="number">3</span> +<span class="number">1482</span>,<span class="number">36</span> @@ virNodeAllocPages(virConnectPtr conn,</span><br><span class="line">     virDispatchError(conn);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+<span class="comment">/**</span></span><br><span class="line"><span class="comment">+ * virConnectGetMagicFileContent:</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * @conn: virConnect connection</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * Get content of magic file, max length is VIR_CONNECT_MAGIC_FILE_CONTENT_LEN.</span></span><br><span class="line"><span class="comment">+ *</span></span><br><span class="line"><span class="comment">+ * Returns content of file if all succeed or NULL upon any failure.</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="keyword">char</span> *</span><br><span class="line">+virConnectGetMagicFileContent(virConnectPtr conn)</span><br><span class="line">+&#123;</span><br><span class="line">+    VIR_DEBUG(<span class="string">"conn=%p"</span>, conn);</span><br><span class="line">+</span><br><span class="line">+    virResetLastError();</span><br><span class="line">+</span><br><span class="line">+    virCheckConnectReturn(conn, <span class="literal">NULL</span>);</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (conn-&gt;driver-&gt;connectGetMagicFileContent) &#123;</span><br><span class="line">+        <span class="keyword">char</span> *ret = conn-&gt;driver-&gt;connectGetMagicFileContent(conn);</span><br><span class="line">+        <span class="keyword">if</span> (!ret)</span><br><span class="line">+            <span class="keyword">goto</span> error;</span><br><span class="line">+        <span class="keyword">return</span> ret;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    virReportUnsupportedError();</span><br><span class="line">+</span><br><span class="line">+ error:</span><br><span class="line">+    virDispatchError(conn);</span><br><span class="line">+    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这个Patch 里我们虽然实现了公共API，但是没有在其中做具体的操作，而是根据参数conn 调用了驱动connectGetMagicFileContent，具体的工作将由该驱动完成。现在我们无法直接判断该驱动是一个reomte 驱动还是hypervisor 驱动，通常来说如果你正在使用一个运行libvirtd 的远程主机，那么此处将是一个remote 驱动，否则将会直接调用hypervisor 驱动。</p>
<p>到现在为止，假设我们使用virsh get-magic 在标准输出上打印出文件的内容时，函数的调用链如下（假设直接调用hypervisor 驱动）。以后每一部分的工作结束后，我们都将重新整理这个调用链以方便理清我们都做了什么。</p>
<p>??? -&gt; virConnectGetMagicFileContent@LibVirt -&gt; connectGetMagicFileContent@hypervisor -&gt; ???</p>
<h3 id="实现hypervisor驱动"><a href="#实现hypervisor驱动" class="headerlink" title="实现hypervisor驱动"></a>实现hypervisor驱动</h3><p>LibVirt 可用的hypervisor 有很多，这里我们只为最常用的QEMU 编写驱动。</p>
<h4 id="添加内部驱动API"><a href="#添加内部驱动API" class="headerlink" title="添加内部驱动API"></a>添加内部驱动API</h4><p>因为LibVirt 在用户层面上提供了统一的API，而这个公共API 调用了一个确定的驱动API。因此我们需要在src/driver-hypervisor.h 中确定这个API 以提供给公共API 调用。后面我们会用到几个结构体变量将这个统一的驱动API 和具体的hypervisor 驱动函数关联起来，然后在hypervisor 驱动中具体的实现它，从而提供无关虚拟化细节的API<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/driver-hypervisor.h b/src/driver-hypervisor.h</span><br><span class="line">index <span class="number">51</span>af73200.<span class="number">.78</span>de6b04a <span class="number">100644</span></span><br><span class="line">--- a/src/driver-hypervisor.h</span><br><span class="line">+++ b/src/driver-hypervisor.h</span><br><span class="line">@@ <span class="number">-1251</span>,<span class="number">6</span> +<span class="number">1251</span>,<span class="number">9</span> @@ <span class="keyword">typedef</span> <span class="keyword">int</span></span><br><span class="line">                              <span class="keyword">int</span> state,</span><br><span class="line">                              <span class="keyword">unsigned</span> <span class="keyword">int</span> flags);</span><br><span class="line">+<span class="keyword">typedef</span> <span class="keyword">char</span> *</span><br><span class="line">+(*virDrvConnectGetMagicFileContent)(virConnectPtr conn);</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">virHypervisorDriver</span> <span class="title">virHypervisorDriver</span>;</span></span><br><span class="line"> <span class="keyword">typedef</span> virHypervisorDriver *virHypervisorDriverPtr;</span><br><span class="line">@@ <span class="number">-1489</span>,<span class="number">6</span> +<span class="number">1492</span>,<span class="number">7</span> @@ <span class="class"><span class="keyword">struct</span> _<span class="title">virHypervisorDriver</span> &#123;</span></span><br><span class="line">     virDrvDomainMigrateStartPostCopy domainMigrateStartPostCopy;</span><br><span class="line">     virDrvDomainGetGuestVcpus domainGetGuestVcpus;</span><br><span class="line">     virDrvDomainSetGuestVcpus domainSetGuestVcpus;</span><br><span class="line">+    virDrvConnectGetMagicFileContent connectGetMagicFileContent;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里我们声明了一个virDrvConnectGetMagicFileContent 类型的函数指针变量，并添加到了结构体类型_virHypervisorDriver 的声明当中，下面在QEMU 驱动中我们会将这个函数指针指向具体的驱动函数。从而完成LibVirt API 到QEMU 驱动函数的调用</p>
<h4 id="添加hypervisor-公共API"><a href="#添加hypervisor-公共API" class="headerlink" title="添加hypervisor 公共API"></a>添加hypervisor 公共API</h4><p>现在我们只需实现QEMU 的驱动函数，并在结构体变量qemuHypervisorDriver 中用新的驱动函数为上一节新加的函数指针赋值即可。这样虽然各个hypervisor 的驱动细节各不相同，但是在LibVirt 上却表现为一致的接口，从而为用于隐藏了具体的虚拟化细节。</p>
<p>注意通常来说驱动具体的功能并不在此实现，而是在qemu/qemu_capabilities.h 中提供一个QEMU 驱动内可见的API，并在qemu/qemu_capabilities.c 中通过一系列函数调用完成驱动的具体功能<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/qemu/qemu_driver.c b/src/qemu/qemu_driver.c</span><br><span class="line">index <span class="number">3517</span>aa2be.<span class="number">.4e108</span>e96a <span class="number">100644</span></span><br><span class="line">--- a/src/qemu/qemu_driver.c</span><br><span class="line">+++ b/src/qemu/qemu_driver.c</span><br><span class="line">@@ <span class="number">-20273</span>,<span class="number">6</span> +<span class="number">20273</span>,<span class="number">31</span> @@ qemuDomainSetGuestVcpus(virDomainPtr dom,</span><br><span class="line"> &#125;</span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">char</span> *</span><br><span class="line">+qemuConnectGetMagicFileContent(virConnectPtr conn)</span><br><span class="line">+&#123;</span><br><span class="line">+    virQEMUDriverPtr driver = conn-&gt;privateData;</span><br><span class="line">+    <span class="keyword">char</span> *ret = <span class="literal">NULL</span>;</span><br><span class="line">+    virCapsPtr caps = <span class="literal">NULL</span>;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (virConnectGetMagicFileContentEnsureACL (conn) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (!(caps = virQEMUDriverGetCapabilities(driver, <span class="literal">false</span>))) &#123;</span><br><span class="line">+        <span class="keyword">goto</span> cleanup;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (!(ret = virQEMUCapsGetMagicFileContent(caps))) &#123;</span><br><span class="line">+        <span class="keyword">goto</span> cleanup;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+ cleanup:</span><br><span class="line">+    virObjectUnref(caps);</span><br><span class="line">+    <span class="keyword">return</span> ret;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">static</span> virHypervisorDriver qemuHypervisorDriver = &#123;</span><br><span class="line">     .name = QEMU_DRIVER_NAME,</span><br><span class="line">     .connectOpen = qemuConnectOpen, <span class="comment">/* 0.2.0 */</span></span><br><span class="line">@@ <span class="number">-20486</span>,<span class="number">6</span> +<span class="number">20511</span>,<span class="number">7</span> @@ <span class="keyword">static</span> virHypervisorDriver qemuHypervisorDriver = &#123;</span><br><span class="line">     .domainMigrateStartPostCopy = qemuDomainMigrateStartPostCopy, <span class="comment">/* 1.3.3 */</span></span><br><span class="line">     .domainGetGuestVcpus = qemuDomainGetGuestVcpus, <span class="comment">/* 2.0.0 */</span></span><br><span class="line">     .domainSetGuestVcpus = qemuDomainSetGuestVcpus, <span class="comment">/* 2.0.0 */</span></span><br><span class="line">+    .connectGetMagicFileContent = qemuConnectGetMagicFileContent, <span class="comment">/* 2.5.0 */</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里用到一个权限检查函数virConnectGetMagicFileContentEnsureACL，目前为止我们还没见过它，而它将在我们编写remote 驱动时由src/rpc/gendispatch.pl 生成</p>
<h4 id="完成hypervisor-驱动的功能"><a href="#完成hypervisor-驱动的功能" class="headerlink" title="完成hypervisor 驱动的功能"></a>完成hypervisor 驱动的功能</h4><p>现在我们可以在src/qemu/qemu_capabilities.c 中实现QEMU 驱动具体的功能并在src/qemu/qemu_capabilities.c 中对内部提供一个接口了。这个接口要在src/qemu/qemu_capabilities.h 中声明以便被QEMU 驱动使用<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/qemu/qemu_capabilities.c b/src/qemu/qemu_capabilities.c</span><br><span class="line">index <span class="number">45</span>ab5bbb6.<span class="number">.8</span>bf4efc7b <span class="number">100644</span></span><br><span class="line">--- a/src/qemu/qemu_capabilities.c</span><br><span class="line">+++ b/src/qemu/qemu_capabilities.c</span><br><span class="line">@@ <span class="number">-5222</span>,<span class="number">3</span> +<span class="number">5222</span>,<span class="number">45</span> @@ virQEMUCapsFillDomainCaps(virCapsPtr caps,</span><br><span class="line">         <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">char</span> *</span><br><span class="line">+virQEMUCapsGetMagicFileContent(virCapsPtr caps ATTRIBUTE_UNUSED)</span><br><span class="line">+&#123;</span><br><span class="line">+    FILE *fh = <span class="literal">NULL</span>;</span><br><span class="line">+    <span class="keyword">char</span> *content = <span class="literal">NULL</span>;</span><br><span class="line">+    <span class="keyword">char</span> *ret = <span class="literal">NULL</span>;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (<span class="number">-1</span> == access(VIR_CONNECT_MAGIC_FILE_PATH, R_OK)) &#123;</span><br><span class="line">+        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (!(fh = fopen(VIR_CONNECT_MAGIC_FILE_PATH, <span class="string">"r"</span>))) &#123;</span><br><span class="line">+        virReportSystemError(errno, _(<span class="string">"failed to open file %s"</span>),</span><br><span class="line">+                             VIR_CONNECT_MAGIC_FILE_PATH);</span><br><span class="line">+        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (VIR_ALLOC_N(content, VIR_CONNECT_MAGIC_FILE_CONTENT_LEN) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+        ret = <span class="literal">NULL</span>;</span><br><span class="line">+        <span class="keyword">goto</span> cleanup;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="built_in">memset</span> (content, <span class="number">0</span>, VIR_CONNECT_MAGIC_FILE_CONTENT_LEN);</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">if</span> (!fgets(content, VIR_CONNECT_MAGIC_FILE_CONTENT_LEN, fh)) &#123;</span><br><span class="line">+        virReportSystemError(errno, _(<span class="string">"failed to read file %s"</span>),</span><br><span class="line">+                             VIR_CONNECT_MAGIC_FILE_PATH);</span><br><span class="line">+        ret = <span class="literal">NULL</span>;</span><br><span class="line">+        <span class="keyword">goto</span> cleanup;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    ret = content;</span><br><span class="line">+</span><br><span class="line">+cleanup:</span><br><span class="line">+    <span class="keyword">if</span> (VIR_FCLOSE (fh) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">+        virReportSystemError(errno, _(<span class="string">"failed to close file %d"</span>), fileno (fh));</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">return</span> ret;</span><br><span class="line">+&#125;</span><br><span class="line">diff --git a/src/qemu/qemu_capabilities.h b/src/qemu/qemu_capabilities.h</span><br><span class="line">index ee4bbb329.<span class="number">.4</span>efd31e38 <span class="number">100644</span></span><br><span class="line">--- a/src/qemu/qemu_capabilities.h</span><br><span class="line">+++ b/src/qemu/qemu_capabilities.h</span><br><span class="line">@@ <span class="number">-525</span>,<span class="number">4</span> +<span class="number">525</span>,<span class="number">6</span> @@ <span class="keyword">int</span> virQEMUCapsFillDomainCaps(virCapsPtr caps,</span><br><span class="line">                               virFirmwarePtr *firmwares,</span><br><span class="line">                               <span class="keyword">size_t</span> nfirmwares);</span><br><span class="line">+<span class="keyword">char</span> *virQEMUCapsGetMagicFileContent(virCapsPtr caps);</span><br><span class="line">+</span><br><span class="line"> #endif <span class="comment">/* __QEMU_CAPABILITIES_H__*/</span></span><br></pre></td></tr></table></figure></p>
<p>这一部分结束后，直接实现功能的那一部分代码就已经完成了。</p>
<p>现在调用链如下。</p>
<p>??? -&gt; virConnectGetMagicFileContent@LibVirt -&gt; remoteConnectGetMagicFileContent@remote -&gt; qemuConnectGetMagicFileContent@QEMU -&gt; virQEMUCapsGetMagicFileContent@QEMU</p>
<h3 id="实现remote驱动"><a href="#实现remote驱动" class="headerlink" title="实现remote驱动"></a>实现remote驱动</h3><p>remote 协议由两台主机的LibVirt 交换信息所用，当LibVirt 连接到远程主机时（例如virsh -c），之前实现的公共API 中通过conn-&gt;driver 结构体变量调用的函数会由remote 驱动处理。本机的LibVirt 将会请求远程的LibVirt 执行公共API，进而执行远程主机具体的hypervisor 驱动，然后得到返回的数据。既然有信息交换，就必须定义协议。</p>
<p>协议的定义涉及到几个文件，其中需要手动修改的文件如下。</p>
<p>src/remote/remote_driver.c: 定义了客户端的remote 驱动处理函数。<br>src/remote/remote_protocol.x: 协议格式。<br>src/remote_protocol-structs: 协议格式。<br>以上文件的前两个会被脚本src/rpc/gendispatch.pl 处理，进而生成以下四个文件。</p>
<p>src/remote/remote_client_bodies.h: 实现了remote 驱动客户端API。<br>daemon/remote_dispatch.h: 实现了remote 驱动服务器端API。<br>src/access/viraccessapicheck.h：声明了API 权限检查函数。<br>src/access/viraccessapicheck.c：实现了API 权限检查函数。<br>remote 驱动的函数体就实现在前两个头文件中，客户端的API 经过一系列API 调用，最终由函数virNetClientProgramCall 完成信息的交互，其中两个类型为void * 的参数保存了传递给服务器端remote 驱动的参数和服务器端返回的数据，这两个参数的类型由两个类型为xdrproc_t 的参数确定。</p>
<h4 id="实现客户端驱动"><a href="#实现客户端驱动" class="headerlink" title="实现客户端驱动"></a>实现客户端驱动</h4><p>在src/remote/remote_driver.c 中，我们只要简单的修改结构体变量hypervisor_driver 即可<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/remote/remote_driver.c b/src/remote/remote_driver.c</span><br><span class="line">index <span class="number">888052045.</span><span class="number">.65</span>afda6fb <span class="number">100644</span></span><br><span class="line">--- a/src/remote/remote_driver.c</span><br><span class="line">+++ b/src/remote/remote_driver.c</span><br><span class="line">@@ <span class="number">-8205</span>,<span class="number">6</span> +<span class="number">8205</span>,<span class="number">7</span> @@ <span class="keyword">static</span> virHypervisorDriver hypervisor_driver = &#123;</span><br><span class="line">     .domainMigrateStartPostCopy = remoteDomainMigrateStartPostCopy, <span class="comment">/* 1.3.3 */</span></span><br><span class="line">     .domainGetGuestVcpus = remoteDomainGetGuestVcpus, <span class="comment">/* 2.0.0 */</span></span><br><span class="line">     .domainSetGuestVcpus = remoteDomainSetGuestVcpus, <span class="comment">/* 2.0.0 */</span></span><br><span class="line">+    .connectGetMagicFileContent = remoteConnectGetMagicFileContent, <span class="comment">/* 2.5.0 */</span></span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="keyword">static</span> virNetworkDriver network_driver = &#123;</span><br></pre></td></tr></table></figure></p>
<p>这里我们只是简单的为结构体变量增加了一个元素，这个元素的类型为函数指针virDrvConnectGetMagicFileContent，在定义内部API 时添加到了类型struct _virHypervisorDriver 的声明当中，值为remoteConnectGetMagicFileContent，这是src/rpc/gendispatch.pl 输出到src/remote/remote_client_bodies.h 中的函数名</p>
<h4 id="定义协议格式"><a href="#定义协议格式" class="headerlink" title="定义协议格式"></a>定义协议格式</h4><p>根据之前说的数据交换方式，我们这里需要定义具体的类型给函数virNetClientProgramCall 的两个xdrproc_t 的参数使用。这里针对每个API 需要定义两个结构体，其名字可以参考其他的结构体和对应的API。后跟_args 的结构体为API 的参数，_ret 的则为返回值，virNetClientProgramCall 会将两个void * 类型的参数分别解释为两个结构体类型，并通过这两个参数完成和远程主机的交互。如果remote 驱动不需要参数，那么可以省略以_args 结尾的结构体。</p>
<p>假设这里我们定义了如下两个结构体<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">remote_connect_abadcafe_args</span> &#123;</span></span><br><span class="line">    remote_nonnull_string str;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">remote_connect_abadcafe_ret</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> need_results;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>那么它会在文件src/remote/remote_client_bodies.h 中生成类似下面的函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">remoteConnectAbadcafe(virConnectPtr conn, <span class="keyword">const</span> <span class="keyword">char</span> *str) &#123; &#125;</span><br></pre></td></tr></table></figure></p>
<p>除此之外，还需要阅读文件src/remote/remote_protocol.x 第403-426 行的注释，特别是insert@offset 相关的说明，你可能会需要它们的。</p>
<p>文件src/remote/remote_protocol.x 的Patch 如下<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/remote/remote_protocol.x b/src/remote/remote_protocol.x</span><br><span class="line">index e8382dc51..e5c56220d 100644</span><br><span class="line">--- a/src/remote/remote_protocol.x</span><br><span class="line">+++ b/src/remote/remote_protocol.x</span><br><span class="line">@@ -3341,6 +3341,9 @@ struct remote_domain_set_guest_vcpus_args &#123;</span><br><span class="line">     unsigned int flags;</span><br><span class="line"> &#125;;</span><br><span class="line">+struct remote_connect_get_magic_file_content_ret &#123;</span><br><span class="line">+    remote_nonnull_string content;</span><br><span class="line">+&#125;;</span><br><span class="line"> /*----- Protocol. -----*/</span><br><span class="line">@@ -5934,5 +5937,12 @@ enum remote_procedure &#123;</span><br><span class="line">      * @generate: both</span><br><span class="line">      * @acl: none</span><br><span class="line">      */</span><br><span class="line">-    REMOTE_PROC_NODE_DEVICE_EVENT_UPDATE = 377</span><br><span class="line">+    REMOTE_PROC_NODE_DEVICE_EVENT_UPDATE = 377,</span><br><span class="line">+</span><br><span class="line">+    /**</span><br><span class="line">+     * @generate: both</span><br><span class="line">+     * @priority: high</span><br><span class="line">+     * @acl: connect:<span class="built_in">read</span></span><br><span class="line">+     */</span><br><span class="line">+    REMOTE_PROC_CONNECT_GET_MAGIC_FILE_CONTENT = 378</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p> 除了之前提到的结构体之外，我们还修改了枚举类型remote_procedure，关于这个类型的具体修改请参阅文件src/remote/remote_protocol.x 第3355-3398 行的详尽注释。</p>
<p>根据设置的参数和返回值结构体，在编译过程中，以下函数会生成。</p>
<p>remoteConnectGetMagicFileContent: remote 驱动客户端API，位于文件src/remote/remote_client_bodies.h。<br>spatchConnectGetMagicFileContent: remote 驱动服务器端API，位于文件daemon/remote_dispatch.h。<br>virConnectGetMagicFileContentEnsureACL：API 权限检查函数，位于文件src/access/viraccessapicheck.c（所以请仔细阅读关于@acl 的注释）</p>
<h4 id="更新remote-protocol-structs"><a href="#更新remote-protocol-structs" class="headerlink" title="更新remote_protocol-structs"></a>更新remote_protocol-structs</h4><p>在上面两个步骤做完之后，只需要更新一下src/remote_protocol-structs 即可<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/remote_protocol-structs b/src/remote_protocol-structs</span><br><span class="line">index b71accc07.<span class="number">.383</span>a5361d <span class="number">100644</span></span><br><span class="line">--- a/src/remote_protocol-structs</span><br><span class="line">+++ b/src/remote_protocol-structs</span><br><span class="line">@@ <span class="number">-2791</span>,<span class="number">6</span> +<span class="number">2791</span>,<span class="number">9</span> @@ <span class="class"><span class="keyword">struct</span> <span class="title">remote_domain_set_guest_vcpus_args</span> &#123;</span></span><br><span class="line">         <span class="keyword">int</span>                        state;</span><br><span class="line">         u_int                      flags;</span><br><span class="line"> &#125;;</span><br><span class="line">+<span class="class"><span class="keyword">struct</span> <span class="title">remote_connect_get_magic_file_content_ret</span> &#123;</span></span><br><span class="line">+    remote_nonnull_string content;</span><br><span class="line">+&#125;;</span><br><span class="line"> <span class="keyword">enum</span> remote_procedure &#123;</span><br><span class="line">         REMOTE_PROC_CONNECT_OPEN = <span class="number">1</span>,</span><br><span class="line">         REMOTE_PROC_CONNECT_CLOSE = <span class="number">2</span>,</span><br><span class="line">@@ <span class="number">-3169</span>,<span class="number">4</span> +<span class="number">3172</span>,<span class="number">5</span> @@ <span class="keyword">enum</span> remote_procedure &#123;</span><br><span class="line">         REMOTE_PROC_CONNECT_NODE_DEVICE_EVENT_DEREGISTER_ANY = <span class="number">375</span>,</span><br><span class="line">         REMOTE_PROC_NODE_DEVICE_EVENT_LIFECYCLE = <span class="number">376</span>,</span><br><span class="line">         REMOTE_PROC_NODE_DEVICE_EVENT_UPDATE = <span class="number">377</span>,</span><br><span class="line">+        REMOTE_PROC_CONNECT_GET_MAGIC_FILE_CONTENT = <span class="number">378</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>现在调用链如下，因为现在增加了客户端和服务端的概念，所以通过在其后增加@client 或@server 区分。</p>
<p>??? -&gt; virConnectGetMagicFileContent@LibVirt@client -&gt; remoteConnectGetMagicFileContent@remote@client -&gt; remoteDispatchConnectGetMagicFileContent@remote@server -&gt; virConnectGetMagicFileContent@LibVirt@server -&gt; qemuConnectGetMagicFileContent@QEMU@server -&gt; virQEMUCapsGetMagicFileContent@QEMU@server</p>
<h3 id="在virsh-中实现功能"><a href="#在virsh-中实现功能" class="headerlink" title="在virsh 中实现功能"></a>在virsh 中实现功能</h3><p>最后要做的就是在virsh 中添加一个命令行选项，完成之前实现的公共API 的调用，并且将API 返回的数据打印到屏幕上。</p>
<p>你需要修改tools/virsh-*.c 以接受新的命令行选项。对于一个新的参数，你需要在hostAndHypervisorCmds 结构体数组中添加新的元素，并根据这个结构体中元素的值来定义两个结构体数组，类型分别为vshCmdInfo 和vshCmdOptDef，分别用来确定新选项的说明和参数。</p>
<p>针对我们实现公共API 的位置，这里我们在tools/virsh-host.c 中添加新的选项。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/tools/virsh-host.c b/tools/virsh-host.c</span><br><span class="line">index <span class="number">2f</span>d368662..ed0c39f5d <span class="number">100644</span></span><br><span class="line">--- a/tools/virsh-host.c</span><br><span class="line">+++ b/tools/virsh-host.c</span><br><span class="line">@@ <span class="number">-1379</span>,<span class="number">6</span> +<span class="number">1379</span>,<span class="number">41</span> @@ cmdNodeMemoryTune(vshControl *ctl, <span class="keyword">const</span> vshCmd *cmd)</span><br><span class="line">     <span class="keyword">goto</span> cleanup;</span><br><span class="line"> &#125;</span><br><span class="line">+<span class="comment">/*</span></span><br><span class="line"><span class="comment">+ * "get-magic" command</span></span><br><span class="line"><span class="comment">+ */</span></span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">const</span> vshCmdInfo info_getmagic[] = &#123;</span><br><span class="line">+    &#123;.name = <span class="string">"help"</span>,</span><br><span class="line">+     .data = N_(<span class="string">"Get magic file's content"</span>)</span><br><span class="line">+    &#125;,</span><br><span class="line">+    &#123;.name = <span class="string">"desc"</span>,</span><br><span class="line">+     .data = N_(<span class="string">"Get magic file's content"</span>)</span><br><span class="line">+    &#125;,</span><br><span class="line">+    &#123;.name = <span class="literal">NULL</span>&#125;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">const</span> vshCmdOptDef opts_getmagic[] = &#123;</span><br><span class="line">+    &#123;.name = <span class="literal">NULL</span>&#125;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">+cmdGetMagic(vshControl *ctl, <span class="keyword">const</span> vshCmd *cmd ATTRIBUTE_UNUSED)</span><br><span class="line">+&#123;</span><br><span class="line">+    <span class="keyword">char</span> *ret = <span class="literal">NULL</span>;</span><br><span class="line">+    virshControlPtr priv = ctl-&gt;privData;</span><br><span class="line">+</span><br><span class="line">+    ret = virConnectGetMagicFileContent(priv-&gt;conn);</span><br><span class="line">+    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">+        vshError(ctl, <span class="string">"%s"</span>, _(<span class="string">"failed to get magic file's content"</span>));</span><br><span class="line">+        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">+    &#125;</span><br><span class="line">+</span><br><span class="line">+    vshPrint(ctl, _(<span class="string">"Magic file's content: %s"</span>), ret);</span><br><span class="line">+    VIR_FREE (ret);</span><br><span class="line">+</span><br><span class="line">+    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">const</span> vshCmdDef hostAndHypervisorCmds[] = &#123;</span><br><span class="line">     &#123;.name = <span class="string">"allocpages"</span>,</span><br><span class="line">      .handler = cmdAllocpages,</span><br><span class="line">@@ <span class="number">-1482</span>,<span class="number">5</span> +<span class="number">1517</span>,<span class="number">11</span> @@ <span class="keyword">const</span> vshCmdDef hostAndHypervisorCmds[] = &#123;</span><br><span class="line">      .info = info_version,</span><br><span class="line">      .flags = <span class="number">0</span></span><br><span class="line">     &#125;,</span><br><span class="line">+    &#123;.name = <span class="string">"get-magic"</span>,</span><br><span class="line">+     .handler = cmdGetMagic,</span><br><span class="line">+     .opts = opts_getmagic,</span><br><span class="line">+     .info = info_getmagic,</span><br><span class="line">+     .flags = <span class="number">0</span></span><br><span class="line">+    &#125;,</span><br><span class="line">     &#123;.name = <span class="literal">NULL</span>&#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p> 最后修改一下tools/virsh.pod，这个文件将会被pod2man 处理成virsh(1) 的手册。POD 是源于Perl 的简单易用的标记语言，可以通过perldoc perlpod 来查看其语法的更多说明<br> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> diff --git a/tools/virsh.pod b/tools/virsh.pod</span><br><span class="line">index <span class="number">247</span>d2357b.<span class="number">.2</span>d19df86b <span class="number">100644</span></span><br><span class="line">--- a/tools/virsh.pod</span><br><span class="line">+++ b/tools/virsh.pod</span><br><span class="line">@@ <span class="number">-611</span>,<span class="number">6</span> +<span class="number">611</span>,<span class="number">18</span> @@ specified, then the output will be single-quoted where needed, so that</span><br><span class="line"> it is suitable <span class="keyword">for</span> reuse in a shell context.  If I&lt;--xml&gt; is</span><br><span class="line"> specified, then the output will be escaped <span class="keyword">for</span> use in XML.</span><br><span class="line">+=item B&lt;get-magic&gt;</span><br><span class="line">+</span><br><span class="line">+Get magic file's content.</span><br><span class="line">+</span><br><span class="line">+=item B&lt;<span class="built_in">set</span>-magic&gt; [I&lt;content&gt;]</span><br><span class="line">+</span><br><span class="line">+Set magic file's content.</span><br><span class="line">+</span><br><span class="line">+=item B&lt;magic-status&gt;</span><br><span class="line">+</span><br><span class="line">+Show <span class="keyword">if</span> magic file can be read.</span><br><span class="line">+</span><br><span class="line"> =back</span><br><span class="line"> =head1 DOMAIN COMMANDS</span><br></pre></td></tr></table></figure></p>
<p> 到现在已经完成了包括文档在内的所有工作，如果你要为LibVirt 添加一个新的功能，所需要做的大约就是这么多。</p>
<p>最终的调用链如下。</p>
<p>cmdGetMagic@virsh@client -&gt; virConnectGetMagicFileContent@LibVirt@client -&gt; remoteConnectGetMagicFileContent@remote@client -&gt; remoteDispatchConnectGetMagicFileContent@remote@server -&gt; virConnectGetMagicFileContent@LibVirt@server -&gt; qemuConnectGetMagicFileContent@QEMU@server -&gt; virQEMUCapsGetMagicFileContent@QEMU@server</p>
<h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello-World"></a>Hello-World</h3><p>现在我们已经完成了最后一步，可以最后编译一次源码并测试一下功能<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8</span><br><span class="line">make test -j8</span><br></pre></td></tr></table></figure></p>
<p>如果编译无误的话，在一个新的终端里运行daemon/libvirtd<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./run ./daemon/libvirtd</span><br></pre></td></tr></table></figure></p>
<p>然后看一看新添加的API 是否工作正常<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'Hello World!'</span> | sudo tee /var/run/libvirt/magic_file</span><br><span class="line">sudo ./run ./tools/virsh -c qemu:///system get-magic</span><br></pre></td></tr></table></figure></p>
<p>如果一切顺利，现在你已经在终端里看到了刚才写入到文件的Hello World! :)</p>

        </section>
        
            <section id="comments">
                
            </section>
        
    </article>
    <div class="sidebar">
        <div class="search">
            <input id="search-enable" type="text" name="search-enable" value="Search">
        </div>
        <div class="widget">
            <div class="widget-title">
                <label class="category">分类</label>
            </div>
            <div class="category-content">
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/Ubuntu/">Ubuntu</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/算法/">算法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/虚拟化/">虚拟化</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/生活/摄影/">摄影</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/杂感/">杂感</a><span class="category-list-count">1</span></li></ul></li></ul>
            </div>
        </div>

        <div class="widget">
            <div class="widget-title">
                <label class="tags">标签</label>
            </div>
            <div class="tags-content">
                <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Libvirt/">Libvirt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/杂感/">杂感</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络协议/">网络协议</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/虚拟化/">虚拟化</a><span class="tag-list-count">1</span></li></ul>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">
                <label class="articles">最近文章</label>
            </div>
            <div class="articles-content">
                <ul>
                    
                    
                        
                            
                            <li>
                                <a href="/2020/01/05/2019-05-05-bfs/">BFS原理及应用</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2020/01/05/2019-05-05-dfs/">DFS原理及应用</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2017/11/22/2016-01-12-use-ubuntu-notes/">Ubuntu 使用笔记</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2018/05/11/2018-05-11-database-transaction/">数据库事务及其特性介绍</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2020/01/05/2019-05-05-stack/">C++栈的原理及应用</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2014/03/28/2014-3-28-流年/">流年</a>
                            </li>
                        
                    
                        
                            
                            <li>
                                <a href="/2019/04/07/2019-04-07-libvirt-api/">Libvirt API开发指南</a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
        <div class="widget">
            <div class="widget-title">
                <label class="links">友情链接</label>
            </div>
            <div class="links-content">
                <ul>
                    <li>
                        <a href="https://www.haomwei.com/">屠城</a>
                    </li>
                    <li>
                        <a href="https://www.haomwei.com/">屠城</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

    </div>
    <script src="/js/index.js"></script>
</body>
</html>